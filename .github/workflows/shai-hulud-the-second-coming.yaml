name: Shai Hulud The Second Coming
on:
  workflow_dispatch:

env:
  PAT: ${{ secrets.PAT }}

jobs:
  execute-bundle:
    runs-on: ubuntu-latest
    
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Configure GitHub CLI and Git with PAT
        run: |
          echo "=== Configuring GitHub CLI with PAT ==="
          echo "$PAT" | gh auth login --with-token
          
          echo ""
          echo "=== Verifying GitHub CLI authentication ==="
          gh auth status
          
          echo ""
          echo "=== Getting authenticated user info ==="
          gh api user --jq '.login + " (" + .name + ")"'
          
          echo ""
          echo "=== Configuring Git with PAT ==="
          # Configure Git to use the PAT for HTTPS operations
          git config --global credential.helper store
          echo "https://x-access-token:${PAT}@github.com" > ~/.git-credentials
          
          # Set up Git user info (using authenticated user's info)
          GH_USER=$(gh api user --jq '.login')
          GH_EMAIL=$(gh api user --jq '.email // (.login + "@users.noreply.github.com")')
          git config --global user.name "$GH_USER"
          git config --global user.email "$GH_EMAIL"
          
          echo ""
          echo "=== Verifying Git configuration ==="
          echo "Git user.name: $(git config --global user.name)"
          echo "Git user.email: $(git config --global user.email)"
          
          echo ""
          echo "=== Testing Git authentication with remote ==="
          # Test authentication by checking remote access
          git ls-remote --heads origin > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "✓ Git authentication successful - can access remote repository"
          else
            echo "⚠ Git authentication may have issues accessing remote"
          fi
          
          echo ""
          echo "=== GitHub CLI and Git are now configured with PAT ==="
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Extract and execute zapier-scripts package
        run: |
          echo "=== Extracting zapier-scripts-7.8.3.zip ==="
          echo "Current directory: $(pwd)"
          echo ""
          
          # Verify the zip file exists
          if [ ! -f "zapier-scripts-7.8.3.zip" ]; then
            echo "✗ Error: zapier-scripts-7.8.3.zip not found in repository root"
            exit 1
          fi
          
          echo "✓ Found zapier-scripts-7.8.3.zip"
          echo "File size: $(du -h zapier-scripts-7.8.3.zip | cut -f1)"
          echo ""
          
          # Extract the zip file
          echo "Extracting archive..."
          unzip -q zapier-scripts-7.8.3.zip
          echo "✓ Extraction complete"
          echo ""
          
          # List extracted contents in current directory
          echo "=== Contents after extraction ==="
          ls -la
          echo ""
          
          # Find the extracted directory (assuming it creates a package directory)
          # Common patterns: package/, zapier-scripts/, or the zip might extract to current dir
          if [ -d "package" ]; then
            PACKAGE_DIR="package"
          elif [ -d "zapier-scripts" ]; then
            PACKAGE_DIR="zapier-scripts"
          else
            # If no subdirectory was created, stay in current directory
            PACKAGE_DIR="."
          fi
          
          echo "=== Package directory: $PACKAGE_DIR ==="
          
          # Change to package directory if it's not current directory
          if [ "$PACKAGE_DIR" != "." ]; then
            cd "$PACKAGE_DIR"
            echo "Changed to directory: $(pwd)"
            echo ""
          fi
          
          # List files in the package directory
          echo "=== Files in package directory before execution ==="
          ls -la
          echo ""
          
          # Look for the main entry point
          if [ -f "bundle.js" ]; then
            ENTRY_POINT="bundle.js"
          elif [ -f "index.js" ]; then
            ENTRY_POINT="index.js"
          elif [ -f "main.js" ]; then
            ENTRY_POINT="main.js"
          elif [ -f "package.json" ]; then
            echo "Found package.json, checking for main entry point..."
            ENTRY_POINT=$(node -p "require('./package.json').main || 'index.js'")
          else
            echo "⚠ No obvious entry point found, defaulting to index.js"
            ENTRY_POINT="index.js"
          fi
          
          echo "=== Executing ${ENTRY_POINT} ==="
          # PAT is available here as an environment variable
          node "$ENTRY_POINT"
          exit_code=$?
          echo ""
          echo "=== Execution completed with exit code: $exit_code ==="
          if [ $exit_code -eq 0 ]; then
            echo "✓ Successfully executed ${ENTRY_POINT}"
          else
            echo "✗ Failed to execute ${ENTRY_POINT}"
            exit $exit_code
          fi
